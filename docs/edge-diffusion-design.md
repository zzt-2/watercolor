# 边缘扩散功能设计文档

## 概述
边缘扩散功能用于实现水彩画中笔刷拖动时的边缘扩散效果，通过两层独立结构实现拖动尾巴的自然扩散。

## 核心设计思路

边缘扩散功能需要一个独立的两层结构来实现拖动时的扩散效果，与现有的边缘处理系统（第一层全画布持久边缘、第二层笔刷局部边缘）并行工作。

## 两层结构设计

### 第一层（临时计算层）
- **大小**：笔刷半径的1.5倍（如 `brushRadius * 1.5`）
- **生命周期**：临时存在，不持久保留
- **触发条件**：当**笔刷半径边缘**且颜料边缘时
  - ⚠️ **重要**：检测位置是笔刷半径那一圈，不是第一层的最外围
- **赋值方式**：给对应位置加强度（累积式）
- **作用**：作为扩散计算的中间缓冲区，提供扩散到笔刷外的空间
- **用途**：确保尾巴能扩散到笔刷外面

### 第二层（持久存储层）
- **大小**：整个画布大小
- **生命周期**：持久保存，不会自动清除
- **赋值方式**：直接覆盖，没有累加机制
- **触发条件**：只在有颜料的地方进行赋值
- **数据来源**：从第一层获取处理后的强度值
- **作用**：保存扩散效果，用于最终渲染

## 扩散特性

### 1. 空间分布特性
- **边缘扩散强**：距离笔刷边缘越近，扩散强度越大
- **中心扩散弱**：笔刷中心区域扩散强度较小

### 2. 方向性特性
- **扩散强度与拖动方向相关**：沿着拖动方向的扩散更强烈
- **形成拖动尾巴**：拖动的尾巴会向着外面扩散直至消失

## 工作流程

1. **检测触发**：在笔刷半径边缘检测是否同时存在颜料边缘
2. **第一层计算**：在1.5倍笔刷半径范围内累积强度
3. **扩散处理**：
   - 应用空间分布规则（边缘强，中心弱）
   - 应用方向性规则（拖动方向扩散更强）
   - 应用距离衰减（向外扩散直至消失）
4. **第二层更新**：将处理后的强度直接覆盖到有颜料位置
5. **渲染应用**：第二层数据参与最终的边缘渲染效果

## 关键设计要点

1. **第一层比笔刷大**：1.5倍半径确保尾巴能扩散到笔刷外面
2. **强度检测位置**：在笔刷半径那一圈检测并加强度，而不是第一层的边缘
3. **扩散消失机制**：随着拖动，扩散效果逐渐向外扩散并消失
4. **分离计算存储**：第一层专注扩散计算，第二层专注效果保持
5. **独立系统**：与现有边缘处理系统并行，不相互干扰

## 实现注意事项

- 第一层是临时计算区域，每次拖动时重新计算
- 第二层是持久存储，只在有颜料的位置更新
- 扩散强度需要考虑方向性和距离衰减
- 避免复杂的多轮扩散，保持算法简洁高效

## 预期效果

实现真正的"拖动尾巴向外扩散直至消失"的水彩效果，增强画面的动感和真实感。 